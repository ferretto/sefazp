require "spec_helper"

describe Sefazp do
  let(:mdfe) { File.open("spec/fixtures/mdfe.xml", "r") }
  let(:cte_sem_exped_receb) { File.open("spec/fixtures/cte_sem_exped_receb.xml", "r") }
  let(:cte_com_exped) { File.open("spec/fixtures/cte_com_exped.xml", "r") }
  let(:cte_com_receb) { File.open("spec/fixtures/cte_com_receb.xml", "r") }
  let(:cte_com_outros_documentos) { File.open("spec/fixtures/cte_com_outros_documentos.xml", "r") }
  let(:nfe) { File.open("spec/fixtures/nfe.xml", "r") }

  describe "parse_mdfe" do
    it "should parse a mdfe" do
      expect(Sefazp.parse_mdfe(mdfe)).to eq({ :municipio_do_emitente=>"3556701", :municipio_de_origem=>"3550308", :municipio_de_destino=>"5208707", :numero=>"2022", :serie=>"1", :chave_de_acesso=>"MDFe35150209494507000113580010000020221000020224", :cnpj_do_emitente=>"09494507000113", :inscricao_estadual_do_emitente=>"714104565119", :nome_do_emitente=>"COOPERATIVA DE TRANSPORTES DE CARGAS COOPEVIN", :nome_fantasia_do_emitente=>"COOPEVIN - VILA MARIA - IRANI / SAO ROBERTO", :logradouro_do_emitente=>"RUA SANTA CRUZ", :numero_do_emitente=>"481", :complemento_do_emitente=>"SALA 1", :bairro_do_emitente=>"JD JUNCO", :cep_do_emitente=>"13280000", :placa_do_veiculo=>"NYB5954", :uf_do_veiculo=>"MG", :nome_do_motorista=>"PAULO HENRIQUE S SILVA FERNANDES", :cpf_do_motorista=>"05964921620", :emissao=>"2015-02-11T10:09:00", :keys=>["35150209494507000113570010000125281000000011", "35150209494507000113570010000125271000000014"] })
    end
  end

  describe "parse_cte" do
    it "should parse a cte without exped and receb" do
      expect(Sefazp.parse_cte(cte_sem_exped_receb)).to eq({ :expedidor=>false, :recebedor=>false, :municipio_do_emitente=>"3556701", :municipio_do_remetente=>"3106200", :municipio_do_destinatario=>"3529401", :municipio_do_expedidor=>nil, :municipio_do_recebedor=>nil, :municipio_de_origem=>"3106200", :municipio_de_destino=>"3529401", :municipio_de_emissao=>"3505708", :numero=>"15424", :serie=>"2", :chave_de_acesso=>"CTe35150110663500000167570020000154241000000014", :tipo_do_cte=>"0", :tipo_do_servico=>"0", :tomador_do_servico=>"0", :forma_de_pagamento=>"0", :codigo_do_cfop=>"6353", :descricao_do_cfop=>"ESTABELECIMENTO COMERCIAL", :cnpj_do_emitente=>"10663500000167", :inscricao_estadual_do_emitente=>"714107634116", :nome_do_emitente=>"ARELLANO VOSS TRANSPORTES LTDA.", :nome_fantasia_do_emitente=>"AVT - BARUERI - DAY BRASIL 1", :logradouro_do_emitente=>"RUA SANTA CRUZ", :numero_do_emitente=>"481", :bairro_do_emitente=>"BARRA FUNDA", :cep_do_emitente=>"13280000", :cnpj_do_remetente=>"49327943000384", :inscricao_estadual_do_remetente=>"0623502100062", :nome_do_remetente=>"DAY BRASIL S/A", :logradouro_do_remetente=>"R CALDAS DA RAINHA", :numero_do_remetente=>"1359", :bairro_do_remetente=>"SAO FRANCISCO", :cep_do_remetente=>"31255180", :cnpj_do_destinatario=>"00023779000160", :inscricao_estadual_do_destinatario=>"442195903117", :nome_do_destinatario=>"POLYSISTEM IMP E EXP DE POLICARBONATO LT", :logradouro_do_destinatario=>"RUA RINALDO CHIAROTTI", :numero_do_destinatario=>"491", :bairro_do_destinatario=>"SERTAOZINHO", :cep_do_destinatario=>"09372060", :cnpj_do_expedidor=>nil, :inscricao_estadual_do_expedidor=>nil, :nome_do_expedidor=>nil, :logradouro_do_expedidor=>nil, :numero_do_expedidor=>nil, :bairro_do_expedidor=>nil, :cep_do_expedidor=>nil, :cnpj_do_recebedor=>nil, :inscricao_estadual_do_recebedor=>nil, :nome_do_recebedor=>nil, :logradouro_do_recebedor=>nil, :numero_do_recebedor=>nil, :bairro_do_recebedor=>nil, :cep_do_recebedor=>nil, :produto_predominante=>"VARIOS", :unidade_de_medida=>"PECAS", :quantidade=>"225", :valor_da_mercadoria=>"45677.25", :responsavel=>"0", :valor_total=>"370.68", :valor_a_receber=>"370.68", :base_de_calculo=>"370.68", :aliquota_icms=>"12.00", :valor_icms=>"44.48", :lotacao=>"1", :data_prevista_de_entrega=>"2015-01-21", :tipo_do_veiculo=>"0", :placa_do_veiculo=>"EWJ1042", :uf_do_veiculo=>"SP", :renavan_do_veiculo=>"00547274670", :tara_em_kg_do_veiculo=>"15750", :capacidade_em_kg_do_veiculo=>"0", :capacidade_em_m3_do_veiculo=>"0", :nome_do_motorista=>"CELIO OLIVEIRA SANTOS", :cpf_do_motorista=>"12403654892", :rntrc=>"46072566", :emissao=>"2015-01-20T12:49:33", :frete=>"370.68", :pedagio=>"0.00", :outros=>"0.00", :keys=>["31150149327943000384550010000318811007008823"] })
    end

    it "should parse a cte with exped" do
      expect(Sefazp.parse_cte(cte_com_exped)).to eq({ :expedidor=>true, :recebedor=>false, :municipio_do_emitente=>"3556701", :municipio_do_remetente=>"3525003", :municipio_do_destinatario=>"3505708", :municipio_do_expedidor=>"3505708", :municipio_do_recebedor=>nil, :municipio_de_origem=>"3525003", :municipio_de_destino=>"3505708", :municipio_de_emissao=>"3505708", :numero=>"13634", :serie=>"2", :chave_de_acesso=>"CTe35141210663500000167570020000136341000000017", :tipo_do_cte=>"0", :tipo_do_servico=>"0", :tomador_do_servico=>"1", :forma_de_pagamento=>"0", :codigo_do_cfop=>"5353", :descricao_do_cfop=>"ESTABELECIMENTO COMERCIAL", :cnpj_do_emitente=>"10663500000167", :inscricao_estadual_do_emitente=>"714107634116", :nome_do_emitente=>"ARELLANO VOSS TRANSPORTES LTDA.", :nome_fantasia_do_emitente=>"AVT - BARUERI - DAY BRASIL 1", :logradouro_do_emitente=>"RUA SANTA CRUZ", :numero_do_emitente=>"481", :bairro_do_emitente=>"BARRA FUNDA", :cep_do_emitente=>"13280000", :cnpj_do_remetente=>"49327943000201", :inscricao_estadual_do_remetente=>"398067583115", :nome_do_remetente=>"DAY BRASIL S/A", :logradouro_do_remetente=>"RUA JOSE ALBINO PEREIRA", :numero_do_remetente=>"318", :bairro_do_remetente=>"JARDIM ALVORADA", :cep_do_remetente=>"06612001", :cnpj_do_destinatario=>"49327943001437", :inscricao_estadual_do_destinatario=>"206109326118", :nome_do_destinatario=>"DAY BRASIL S/A", :logradouro_do_destinatario=>"AV DR HUMBERTO GIANNELLA", :numero_do_destinatario=>"937", :bairro_do_destinatario=>"JD BELVAL", :cep_do_destinatario=>"06422130", :cnpj_do_expedidor=>"49327943001437", :inscricao_estadual_do_expedidor=>"206109326118", :nome_do_expedidor=>"DAY BRASIL S/A", :logradouro_do_expedidor=>"AV DR HUMBERTO GIANNELLA", :numero_do_expedidor=>"937", :bairro_do_expedidor=>"JARDIM BELVAL", :cep_do_expedidor=>"06422130", :cnpj_do_recebedor=>nil, :inscricao_estadual_do_recebedor=>nil, :nome_do_recebedor=>nil, :logradouro_do_recebedor=>nil, :numero_do_recebedor=>nil, :bairro_do_recebedor=>nil, :cep_do_recebedor=>nil, :produto_predominante=>"VARIOS", :unidade_de_medida=>"CAIXA", :quantidade=>"126", :valor_da_mercadoria=>"26908.91", :responsavel=>"0", :valor_total=>"643.64", :valor_a_receber=>"643.64", :base_de_calculo=>"643.64", :aliquota_icms=>"12.00", :valor_icms=>"77.24", :lotacao=>"1", :data_prevista_de_entrega=>"2014-12-13", :tipo_do_veiculo=>"0", :placa_do_veiculo=>"KFM0337", :uf_do_veiculo=>"DF", :renavan_do_veiculo=>"00185619878", :tara_em_kg_do_veiculo=>"0", :capacidade_em_kg_do_veiculo=>"0", :capacidade_em_m3_do_veiculo=>"0", :nome_do_motorista=>"ODETIO ALVES DA SILVA", :cpf_do_motorista=>"99815940830", :rntrc=>"46072566", :emissao=>"2014-12-12T13:40:44", :frete=>"336.01", :pedagio=>"0.00", :outros=>"307.63", :keys=>["35141249327943000201550020000193751005308451", "35141249327943000201550020000193801002879334", "35141249327943000201550020000193771001795565", "35141249327943000201550020000193741002231590", "35141249327943000201550020000193811009208874", "35141249327943000201550020000193791005119437", "35141249327943000201550020000193761004903116", "35141249327943000201550020000193781003499189"] })
    end

    it "should parse a cte with receb" do
      expect(Sefazp.parse_cte(cte_com_receb)).to eq({ :expedidor=>false, :recebedor=>true, :municipio_do_emitente=>"3556701", :municipio_do_remetente=>"3505708", :municipio_do_destinatario=>"3550308", :municipio_do_expedidor=>nil, :municipio_do_recebedor=>"3523107", :municipio_de_origem=>"3505708", :municipio_de_destino=>"3523107", :municipio_de_emissao=>"3505708", :numero=>"6726", :serie=>"1", :chave_de_acesso=>"CTe35140910663500000167570010000067261000000017", :tipo_do_cte=>"0", :tipo_do_servico=>"0", :tomador_do_servico=>"0", :forma_de_pagamento=>"0", :codigo_do_cfop=>"5352", :descricao_do_cfop=>"ESTABELECIMENTO INDUSTRIAL", :cnpj_do_emitente=>"10663500000167", :inscricao_estadual_do_emitente=>"714107634116", :nome_do_emitente=>"ARELLANO VOSS TRANSPORTES LTDA.", :nome_fantasia_do_emitente=>"AVT - BARUERI - JAGUARE", :logradouro_do_emitente=>"RUA SANTA CRUZ", :numero_do_emitente=>"481", :bairro_do_emitente=>"JARDIM JUNCO", :cep_do_emitente=>"13280000", :cnpj_do_remetente=>"44003911000148", :inscricao_estadual_do_remetente=>"206015980110", :nome_do_remetente=>"EMBALAGENS JAGUARE LTDA", :logradouro_do_remetente=>"RUA LOURIVAL MARQUES DOS SANTOS", :numero_do_remetente=>"50", :bairro_do_remetente=>"JARDIM BELVAL", :cep_do_remetente=>"06422143", :cnpj_do_destinatario=>"10251511000130", :inscricao_estadual_do_destinatario=>"148238754112", :nome_do_destinatario=>"LIQUID IDEIAS COMERCIO E SERVICOS LTDA - EPP", :logradouro_do_destinatario=>"RUA JOAO DE SOUZA DIAS", :numero_do_destinatario=>"143", :bairro_do_destinatario=>"CAMPO BELO", :cep_do_destinatario=>"04618000", :cnpj_do_expedidor=>nil, :inscricao_estadual_do_expedidor=>nil, :nome_do_expedidor=>nil, :logradouro_do_expedidor=>nil, :numero_do_expedidor=>nil, :bairro_do_expedidor=>nil, :cep_do_expedidor=>nil, :cnpj_do_recebedor=>"00561276000149", :inscricao_estadual_do_recebedor=>"379049157118", :nome_do_recebedor=>"CLAUDEONOR TEIXEIRA CAIRES FILHO - ME", :logradouro_do_recebedor=>"RUA EVANGELHO QUADRANGULAR", :numero_do_recebedor=>"119", :bairro_do_recebedor=>"VL VIRINIA", :cep_do_recebedor=>"08599000", :produto_predominante=>"PAPEL", :unidade_de_medida=>"PALLETS", :quantidade=>"10", :valor_da_mercadoria=>"3555.84", :responsavel=>"0", :valor_total=>"333.21", :valor_a_receber=>"333.21", :base_de_calculo=>"333.21", :aliquota_icms=>"12.00", :valor_icms=>"39.99", :lotacao=>"1", :data_prevista_de_entrega=>"2014-09-19", :tipo_do_veiculo=>"0", :placa_do_veiculo=>"BTP2474", :uf_do_veiculo=>"SP", :renavan_do_veiculo=>"638420024", :tara_em_kg_do_veiculo=>"0", :capacidade_em_kg_do_veiculo=>"0", :capacidade_em_m3_do_veiculo=>"0", :nome_do_motorista=>"CARLOS CALSOLARI SOBRINHO", :cpf_do_motorista=>"07946041888", :rntrc=>"46072566", :emissao=>"2014-09-18T20:23:07", :frete=>"304.12", :pedagio=>"29.09", :outros=>"0.00", :keys=>["35140944003911000148550010000670091528272072"] })
    end

    it "should parse a cte with outros documentos" do
      expect(Sefazp.parse_cte(cte_com_outros_documentos)).to eq({ :expedidor=>false, :recebedor=>false, :municipio_do_emitente=>"3556701", :municipio_do_remetente=>"3505708", :municipio_do_destinatario=>"4208203", :municipio_do_expedidor=>nil, :municipio_do_recebedor=>nil, :municipio_de_origem=>"3505708", :municipio_de_destino=>"4208203", :municipio_de_emissao=>"3505708", :numero=>"4158", :serie=>"1", :chave_de_acesso=>"CTe35140310663500000167570010000041581000000017", :tipo_do_cte=>"0", :tipo_do_servico=>"0", :tomador_do_servico=>"0", :forma_de_pagamento=>"0", :codigo_do_cfop=>"6352", :descricao_do_cfop=>"ESTABELECIMENTO INDUSTRIAL", :cnpj_do_emitente=>"10663500000167", :inscricao_estadual_do_emitente=>"714107634116", :nome_do_emitente=>"ARELLANO VOSS TRANSPORTES LTDA.", :nome_fantasia_do_emitente=>"AVT - BARUERI", :logradouro_do_emitente=>"AV. DOS IMIGRANTES", :numero_do_emitente=>"327", :bairro_do_emitente=>"JARDIM JUNCO", :cep_do_emitente=>"13280000", :cnpj_do_remetente=>"10498628000112", :inscricao_estadual_do_remetente=>"206269625112", :nome_do_remetente=>"BIO SERVICE GROUP EMBALAGENS LTDA", :logradouro_do_remetente=>"RUA LOURIVAL MARQUES DOS SANTOS", :numero_do_remetente=>"130", :bairro_do_remetente=>"JARDIM BELVAL", :cep_do_remetente=>"06422143", :cnpj_do_destinatario=>"08833357000243", :inscricao_estadual_do_destinatario=>"256493286", :nome_do_destinatario=>"CVN COMERCIO IMPORT.EXPORT. E DISTRIB. DE PECAS AUTOM LTDA.", :logradouro_do_destinatario=>"RUA ROSA ORSI DALCOQUIO", :numero_do_destinatario=>"464", :bairro_do_destinatario=>"CORDEIROS", :cep_do_destinatario=>"88311720", :cnpj_do_expedidor=>nil, :inscricao_estadual_do_expedidor=>nil, :nome_do_expedidor=>nil, :logradouro_do_expedidor=>nil, :numero_do_expedidor=>nil, :bairro_do_expedidor=>nil, :cep_do_expedidor=>nil, :cnpj_do_recebedor=>nil, :inscricao_estadual_do_recebedor=>nil, :nome_do_recebedor=>nil, :logradouro_do_recebedor=>nil, :numero_do_recebedor=>nil, :bairro_do_recebedor=>nil, :cep_do_recebedor=>nil, :produto_predominante=>"PAPEL", :unidade_de_medida=>"PALLETS", :quantidade=>"1", :valor_da_mercadoria=>"200.00", :responsavel=>"0", :valor_total=>"260.45", :valor_a_receber=>"260.45", :base_de_calculo=>"260.45", :aliquota_icms=>"12.00", :valor_icms=>"31.25", :lotacao=>"1", :data_prevista_de_entrega=>"2014-03-29", :tipo_do_veiculo=>"0", :placa_do_veiculo=>"NPF1148", :uf_do_veiculo=>"SP", :renavan_do_veiculo=>"161073042", :tara_em_kg_do_veiculo=>"0", :capacidade_em_kg_do_veiculo=>"0", :capacidade_em_m3_do_veiculo=>"0", :nome_do_motorista=>"JOAO VITORINO", :cpf_do_motorista=>"02917896841", :rntrc=>"46072566", :emissao=>"2014-03-28T15:33:33", :frete=>"260.45", :pedagio=>"0.00", :outros=>"0.00", :keys=>["000667"] })
    end
  end

  describe "parse_nfe" do
    it "should parse a nfe" do
      expect(Sefazp.parse_nfe(nfe)).to eq({ :municipio_do_emitente=>"3505708", :municipio_do_destinatario=>"3527306", :chave_de_acesso=>"35131110498628000112550010000005781414285856", :numero=>"578", :serie=>"1", :natureza_da_operacao=>"OUTRAS SAIDAS OU PRESTACOES DE SERVICO NAO ESPECIFICADAS", :protocolo_de_autorizacao=>"135130715901757 2013-11-22T14:23:28", :cnpj_do_emitente=>"10498628000112", :inscricao_estadual_do_emitente=>"206269625112", :nome_do_emitente=>"BIO SERVICE GROUP EMBALAGENS LTDA", :logradouro_do_emitente=>"RUA LOURIVAL MARQUES DOS SANTOS", :numero_do_emitente=>"130", :bairro_do_emitente=>"JARDIM BELVAL", :cep_do_emitente=>"06422143", :telefone_do_emitente=>"1142471227", :documento_do_destinatario=>"01377724000464", :inscricao_estadual_do_destinatario=>"421076409112", :nome_do_destinatario=>"BRASALPLA BRASIL - INDUSTRIA DE EMBALAGENS LTDA.", :logradouro_do_destinatario=>"RUA AV JOSE MAMPRIM", :numero_do_destinatario=>"999", :bairro_do_destinatario=>"SANTO ANTONIO", :cep_do_destinatario=>"13290000", :telefone_do_destinatario=>"1938488034", :data_de_emissao=>"2013-11-22", :data_de_entrada_saida=>"2013-11-22", :hora_de_entrada_saida=>"00:00:00", :base_de_calculo_do_icms=>"0.00", :valor_do_icms=>"0.00", :valor_dos_produtos=>"6531.60", :valor_do_frete=>"0.00", :valor_do_seguro=>"0.00", :valor_do_desconto=>"0.00", :valor_de_outras_despesas=>"0.00", :valor_do_ipi=>"0.00", :valor_total_da_nota=>"6531.60", :frete_por_conta=>"9", :quantidade=>"12", :especie=>"pallets", :peso_bruto=>"3580.000", :peso_liquido=>"3151.590", :informacoes_complementares=>"Nao incidencia do ICMS, conforme artigo 7  IX, Decreto n 45490/00  - OC.124283/1  OC.124283/1", :items=>[{"codigo"=>"IE-000063", "descricao"=>"COD  500177-CINTA QUADRADA", "ncm_sh"=>"48191000", "cfop"=>"5949", "unidade"=>"PC", "quantidade"=>"120.0000", "valor_unitario"=>"1.0800000000", "valor_total"=>"129.60", "cst"=>nil, "base_de_calculo_do_icms"=>nil, "valor_do_icms"=>nil, "aliquota_do_icms"=>nil}, {"codigo"=>"IE-000010", "descricao"=>"BANDEJA NO  2 1 - FP", "ncm_sh"=>"48191000", "cfop"=>"5949", "unidade"=>"PC", "quantidade"=>"1650.0000", "valor_unitario"=>"3.8800000000", "valor_total"=>"6402.00", "cst"=>nil, "base_de_calculo_do_icms"=>nil, "valor_do_icms"=>nil, "aliquota_do_icms"=>nil}] })
    end
  end
end
